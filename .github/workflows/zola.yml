on:
  push:
    branches:
      - master
      - gh-pages-*
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@master
      - name: 'Prepare for building'
        run: |
          # Add readme and changelog
          tail -n +8 README.md | sed 's/## /# /g' >> website/content/_index.md
          tail -n +3 CHANGELOG.md | sed 's/## /# /g' >> website/content/CHANGELOG.md
          # Replace hardcoded gitlab pages urls
          OLD_URL="islandoftex.gitlab.io/arara"
          NEW_URL="$GITHUB_REPOSITORY_OWNER.github.io/${GITHUB_REPOSITORY#*/}"
          PATTERN="s|$OLD_URL|$NEW_URL|g"
          find website -type f \
            -not -path "website/themes/*" \
            \( -name '*.md' -o -name '*.css' -o -name '*.toml' \) \
            -exec sed -i $PATTERN {} \;
          # checkout LFS
          git lfs pull --include=website
      - name: 'Build and deploy'
        uses: shalzz/zola-deploy-action@master
        env:
          PAGES_BRANCH: gh-pages
          BUILD_DIR: website
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
